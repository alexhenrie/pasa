<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>

    <!-- Raisin picture is CC-BY-SA-2.5 from Cary Bass, https://commons.wikimedia.org/wiki/File:Single_raisin.jpg -->
    <link rel="icon" type="image/png" href="favicon.png"/>

    <link href="bootstrap.min.css" rel="stylesheet" />

    <style>
      label {
        -moz-user-select: none;
        user-select: none;
      }
      td {
        padding-left: 25px;
        padding-right: 25px;
        vertical-align: top;
      }
      #passwordCell {
        border-bottom: none;
        border-right: 1px solid black;
        width: 50ex;
      }
      /* big screen */
      @media not all and (max-width: 100ex) {
        h2 {
          margin-top: 0;
        }
        .small-screen {
          display: none;
        }
      }
      /* small screen */
      @media (max-width: 100ex) {
        td {
          display: inline-block;
          padding-bottom:25px;
        }
        .big-screen {
          display: none;
        }
        #passwordCell {
          border-bottom: 1px solid black;
          border-right: none;
          width: auto;
        }
      }
    </style>

    <style id="styleblock"></style>

    <script>//<![CDATA
      var preferences = Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefBranch);

      function rememberSignons() {
        preferences.setBoolPref('signon.rememberSignons', true);
        document.getElementById('rememberSignons').parentNode.removeChild(document.getElementById('rememberSignons'));
      }

      function syncSignons() {
        preferences.setBoolPref('services.sync.engine.passwords', true);
        document.getElementById('syncSignons').parentNode.removeChild(document.getElementById('syncSignons'));
      }

      function passwordToClipboard() {
        var clipboard = Components.classes["@mozilla.org/widget/clipboardhelper;1"].getService(Components.interfaces.nsIClipboardHelper);
        clipboard.copyString(document.getElementById('password').textContent);
      }
    //]></script>

    <title>Generate password</title>
  </head>
  <body class="container">
    <script>//<![CDATA
      if (!preferences.getBoolPref("signon.rememberSignons"))
        document.write("<div class=\"alert alert-warning\" id=\"rememberSignons\">Firefox does not currently ask to remember passwords. <a href=\"javascript:rememberSignons()\">Click here to fix that.</a></div>");
      if (!preferences.prefHasUserValue("services.sync.account"))
        document.write("<div class=\"alert alert-warning\">Your passwords saved in Firefox are not currently backed up via Firefox Sync because you are not currently signed in to Firefox Sync. <a href=\"about:accounts\" target=\"_new\">Sign in to Firefox Sync</a> to back up your passwords automatically.</div>");
      if (preferences.prefHasUserValue("services.sync.engine.passwords"))
        document.write("<div class=\"alert alert-warning\" id=\"syncSignons\">Your passwords saved in Firefox are not currently backed up via Firefox Sync because password sync is turned off. <a href=\"javascript:syncSignons()\">Click here to fix that.</a></div>");
    //]]></script>

    <div class="btn" style="font-size:x-large; float:right"><a href="chrome://passwordmgr/content/passwordManager.xul" target="_new">View saved passwords</a></div>

    <table style="clear:both; margin-left:auto; margin-right:auto">
      <tr>
        <td id="passwordCell">
          <h2>The following new password has been copied to the clipboard:</h2>

          <div style="display:inline-block; font-family:monospace; position:relative">
            <div id="password" style="color:transparent; font-size:xx-large; padding:0.5em 1em 0.5em 1em; position:absolute"></div>
            <div id="dots" style="font-size:xx-large; padding:0.5em 1em 0.5em 1em">&nbsp;</div>
          </div>

          <p>After setting your password for a website, sign out and sign back in to make sure that Firefox saved the password. If it is not saved anywhere else, then <span style="font-weight:bold">this password will be gone for good</span> when you close this page, refresh this page, or generate a new password on this page.</p>

          <a class="btn btn-lg btn-primary small-screen" href="javascript:passwordToClipboard()">Copy to clipboard again</a>
        </td>
        <td>
          <form action="" class="form-horizontal" id="form" method="get">
            <h2>Options</h2>

            <div class="form-group" style="margin-left:0">
              <div class="checkbox">
                <label for="miniscule">
                  <input checked="checked" id="miniscule" name="miniscule" type="checkbox"/>
                  Lowercase letters
                </label>
              </div>
            </div>

            <div class="form-group" style="margin-left:0">
              <div class="checkbox">
                <label>
                  <input checked="checked" id="majiscule" name="majiscule" type="checkbox"/>
                  Uppercase letters
                </label>
              </div>
            </div>

            <div class="form-group" style="margin-left:0">
              <div class="checkbox">
                <label>
                  <input checked="checked" id="numbers" name="numbers" type="checkbox"/>
                  Numbers
                </label>
              </div>
            </div>

            <div class="form-group" style="margin-left:0">
              <div class="checkbox">
                <label>
                  <input id="symbols" name="symbols" type="checkbox" style="float:none"/>
                  Symbols:
                </label>
                <input id="oksymbols" class="form-control" name="oksymbols" oninput="document.getElementById('symbols').checked = true" style="display:inline; width:20ex" type="text" value="-_."/>
              </div>
            </div>

            <div class="form-group" style="margin-left:0">
              <div>
                Length:
                <input style="display:inline; width:10ex" class="form-control" id="length" name="length" type="number" min="1" value="10"/>
              </div>
            </div>

            <input class="btn btn-primary btn-lg small-screen" type="submit" value="Generate another password"/>
          </form>
        </td>
      </tr>
      <tr class="big-screen">
        <td style="border-right:1px solid black">
          <a class="btn btn-lg btn-primary" href="javascript:passwordToClipboard()">Copy to clipboard again</a>
        </td>
        <td>
          <a class="btn btn-primary btn-lg" href="javascript:document.getElementById('form').submit()">Generate another password</a>
        </td>
      </tr>
    </table>

    <script>//<![CDATA[
      var useDefaults = (location.href.indexOf("?") == -1);

      var params = {};
      function applyCheckboxParam(name) {
        if (useDefaults) {
          params[name] = document.getElementById(name).checked;
        } else {
          params[name] = location.href.indexOf(name + "=on") != -1;
          document.getElementById(name).checked = params[name] ? true : false;
        }
      }
      applyCheckboxParam("miniscule");
      applyCheckboxParam("majiscule");
      applyCheckboxParam("numbers");
      applyCheckboxParam("symbols");

      var minisculePool = "abcdefghijklmnopqrstuvwxyz";
      var majisculePool = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      var numberPool = "0123456789";
      var symbolPool = decodeURIComponent((/oksymbols=([^&]+)/g.exec(location.href) || ["", ""])[1]);

      var charPool = "";
      if (params["miniscule"])
        charPool += minisculePool;
      if (params["majiscule"])
        charPool += majisculePool;
      if (params["numbers"])
        charPool += numberPool;
      if (params["symbols"])
        charPool += symbolPool;

      if (symbolPool)
        document.getElementById("oksymbols").value = symbolPool;

      var length = (/length=([^&]+)/g.exec(location.href) || ["", ""])[1];
      if (length)
          document.getElementById("length").value = length;
      length = document.getElementById("length").value;

      var password;
      do {
          password = "";
          for (var i = 0; i < length; i++)
            password += charPool[Math.floor(Math.random() * charPool.length)];
      } while ((params["miniscule"] && !(new RegExp("[" + minisculePool + "]", "g")).exec(password)) ||
               (params["majiscule"] && !(new RegExp("[" + majisculePool + "]", "g")).exec(password)) ||
               (params["numbers"] && !(new RegExp("[" + numberPool + "]", "g")).exec(password)) ||
               (params["symbols"] && symbolPool && !(new RegExp("[" + symbolPool.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1") + "]", "g")).exec(password)))

      document.getElementById("password").textContent = password;
      passwordToClipboard();

      //flashy animation for visual feedback
      for (var i = 0; i < length; i++) {
        setTimeout(function(i) {
          document.getElementById("styleblock").textContent = "#dots:before{content:'" + new Array(i + 2).join("●") + "'}";
        }, (500 / length) * (i + 1), i);
      }
    //]]></script>
  </body>
</html>
